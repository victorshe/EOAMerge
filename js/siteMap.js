define("/DigiShell/js/siteMap",["backbone/backbone/1.1.0/backbone","jquery","backbone/underscore/1.5.2/underscore","./sidebar","./util"],function(a,b){function c(a,b){var c=[];return a.each(function(d){var f=a.where({parentId:d.get("id")});f.length>0&&(f=e.filter(f,function(b){return!a.findWhere({parentId:b.id})}),"function"==typeof b&&(f=e.filter(f,b)),f.length>0&&c.push(e.extend({},d.attributes,{children:f})))}),c}var d=a("backbone/backbone/1.1.0/backbone"),e=a("backbone/underscore/1.5.2/underscore"),f=a("./sidebar"),g={},h=d.View.extend({mapItems:null,initialize:function(a){var b=this;this.$el.html('<div class="span4"></div><div class="span4"></div><div class="span4"></div>'),f.getMenu("siteMap").getItem("root",function(){b.model=this.clone(),b.model.type=this.type,b.model.forForm="form"===a.mode,a.filter&&b.model.reset(b.model.filter(a.filter)),b.render(a)})},events:{"click .widget-toolbar  > [data-action]":"clickTools","click .widget-body li":"clickItem"},clickTools:function(a){a.preventDefault();var b=$(a.currentTarget),c=b.data("action"),d=b.closest(".widget-box");if("collapse"===c){var e=d.find(".widget-body"),f=b.find("[class*=icon-]").eq(0),g=f.attr("class").match(/icon\-(.*)\-(up|down)/),h="icon-"+g[1]+"-down",i="icon-"+g[1]+"-up",j=e.find(".widget-body-inner");e=0===j.length?e.wrapInner('<div class="widget-body-inner"></div>').find(":first-child").eq(0):j.eq(0);var k=300,l=200;d.hasClass("collapsed")?(f&&f.addClass(i).removeClass(h),d.removeClass("collapsed"),e.slideUp(0,function(){e.slideDown(k)})):(f&&f.addClass(h).removeClass(i),e.slideUp(l,function(){d.addClass("collapsed")}))}return!0},clickItem:function(a){var b=$(a.currentTarget),c=b.index(),d=b.closest(".widget-box").data("index"),e=this.mapItems[d].children[c];this.selectable?"INPUT"===a.target.tagName&&(e.set("selected",b.find("input:checkbox").prop("checked")),this.$el.trigger("select",[e,this.model.where({selected:!0})])):(this.model.openItem(e,a),window.scrollTo(0,0))},itemTemplate:e.template('<div class="widget-box" data-index="<%=index%>"><div class="widget-header"><h5 class="widget-title"><i class="<%=ico%>"></i><%=name%></h5><div class="widget-toolbar"><a href="#" data-action="collapse"><i class="icon-chevron-up"></i></a></div></div><div class="widget-body"><ul class="item-list"><%_.each(children,function(child){var info = child.attributes;%><li class="item-none"><a class="inline" href="#m_siteMap/<%=info.id%>"><i class="<%=info.ico%>"></i><%=mode!=="form"?info.name:info.formName%></a></li><%});%></ul></div></div><div class="space-4"></div>'),itemSelectTemplate:e.template('<div class="widget-box" data-index="<%=index%>"><div class="widget-header"><h5 class="widget-title"><i class="<%=ico%>"></i><%=name%></h5><div class="widget-toolbar"><a href="#" data-action="collapse"><i class="icon-chevron-up"></i></a></div></div><div class="widget-body"><ul class="item-list"><%_.each(children,function(child){var info = child.attributes;%><li class="item-none"><label class="inline"><input type="checkbox" class="ace" <%=info.selected?"checked":""%>/><span class="lbl"><%=mode!=="form"?info.name:info.formName%></span></label></li><%});%></ul></div></div><div class="space-4"></div>'),render:function(a){var b=this.$el.find("> div"),d=this;return a.selected&&a.selected.each(function(b){var c=a.model.get(b.id);c&&c.set("selected",!0)}),d.mapItems=c(d.model),e.each(this.mapItems,function(c,f){$(b.get(f%3)).append((a.selectable?d.itemSelectTemplate:d.itemTemplate)(e.extend({menuId:a.id,mode:a.mode,index:f,ico:""},c)))}),this}});b.getSiteMap=function(a,b){return g[a]?g[a]:function(){return b=b||{},-1!==a.indexOf("Form")&&e.defaults(b,{mode:"form",filter:function(a){return a.get("form")&&a.get("formName")||""===a.get("view")}}),g[a]=new h(b),g[a]}()}});