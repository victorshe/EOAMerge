define("/DigiShell/js/viewFrame",["digiflow/0.2/viewPanel","jquery","backbone/backbone/1.1.0/backbone","backbone/underscore/1.5.2/underscore","./logo","./util"],function(a,b,c){function d(a,b,c){$.post("/Produce/DigiShell.nsf/deleteDocumentXAgent.xsp",{u:a.join(","),p:k.get("view").dbPath,d:b},function(){$.isFunction(c)&&c()},"json").error(function(){alert("连接已断开，请重新登录")})}{var e=a("digiflow/0.2/viewPanel"),f=a("backbone/backbone/1.1.0/backbone"),g=a("./logo");a("./util")}a("jquery/gritter/1.7.4/jquery.gritter");var h=function(){var a,b;return function(c,d,e,f){f&&!a&&(a=$("#viewFrame .page-header").outerHeight(!0),30>a&&(a=67)),b||(b=$("#viewFrame .pagination").outerHeight(!0)||75);var g=($(window).height()-c-(f?a:0)-b)/($(d).height()*e);return g>8?parseInt(g)-1:8}}(),i=f.Model.extend({defaults:{view:{dbPath:"",view:"",category:"",key:"",page:1},queryFrame:!1,showHeader:!0,allowDelete:null,allowDeleteCache:null,isDraft:!1},frame:null,initialize:function(){this.frame=new j({model:this})},openView:function(a){this.set({queryFrame:null,isDraft:!1,allowDelete:this.get("allowDeleteCache")}),"class"in a&&(a.category=a["class"],delete a["class"]),a.draft&&this.set({allowDelete:!0,isDraft:!0}),"showHeader"in a?(this.set("showHeader",!!a.showHeader),delete a.showHeader):this.set("showHeader",!0),this.set("view",$.extend({dbPath:"",view:""},a)),$(".page-content >.active").removeClass("active"),$(".page-content .view").addClass("active").slideDown(),$(".databaseQuery").hide(),$(".viewData").slideDown()}}),j=f.View.extend({id:"viewFrame",className:"viewFrame span12",model:null,initialize:function(){var a=this,b=$(".view");b.append(this.$el.append('<div class="page-header"><div class="view-breadcrumb"></div><div class="view-toolbar btn-toolbar"></div></div><div class="viewData"></div>')),e.init({checkbox:!0,count:h(b.offset().top||$(".widgetContent").offset().top,$("#breadcrumbs"),.95,!0),checkboxTemplate:function(a){return'<label><input type="checkbox" class="ace"/><span class="lbl">'+a+"</span></label>"},infoReady:function(b){a.model.set({allowDelete:!!b.allowDelete||a.model.get("isDraft"),allowDeleteCache:!!b.allowDelete||a.model.get("isDraft")})}}),this.listenTo(this.model,"change:view",function(){this.render()}),this.listenTo(g,"change:isExpan",function(){e.config({count:h(b.offset().top||$(".widgetContent").offset().top,$("#breadcrumbs"),.95,this.model.get("showHeader"))}),$(".viewData:visible").size()>0&&e.refresh()}),this.listenTo(this.model,"change:allowDelete",function(){a.model.get("showHeader")&&a.showToolbar(a.model.get("allowDelete"))}),this.listenTo(this.model,"change:showHeader",function(){var a=this.model.get("showHeader");this.$el.find(".page-header").css("display",a?"block":"none"),e.config({checkbox:a?!0:!1,count:h(b.offset().top||$(".widgetContent").offset().top,$("#breadcrumbs"),.95,a)})})},events:{"click .view-toolbar button":"toolsAction","click .view-toolbar ul.export":"exportAction"},render:function(){e.openView(this.model.get("view"))},showToolbar:function(a){var b=this.$el.find(".view-toolbar"),c='<div class="btn-group"><button class="btn btn-danger" data-action="delete" title="删除"><i class="icon-trash"></i></button></div>';b.html('<div class="btn-group"><button class="btn btn-info" data-toggle="dropdown" data-action="query" title="查找"><i class="icon-search"></i></button><ul class="dropdown-menu dropdown-default query"></ul></div>'+(a?c:"")+'<div class="btn-group"><button class="btn btn-success" data-action="refresh" title="刷新"><i class="icon-refresh"></i></button></div><div class="btn-group"><button class="btn btn-grey dropdown-toggle" data-action="export" data-toggle="dropdown" title="导出"><i class="icon-share"></i></button><ul class="dropdown-menu dropdown-default pull-right export"><li><a href="#current">导出当前页</a></li><li><a href="#all">导出所有页</a></li></ul></div>')},toolsAction:function(b){var c=$(b.currentTarget),f=c.data("action"),g=this;switch(f){case"query":c.parent().hasClass("open")||a.async("./databaseQuery",function(a){a.getQueryNames(g.model.get("view").dbPath,function(a){var b="",d=0;for(var e in a)b+="<li><a href='"+/\S+(#m_\S+?\/[^\/]+)\S*/.exec(location.href)[1]+"/q_"+e+"'>"+a[e].name+"</a></li>",d++;b+="";var f=g.$el.find(".dropdown-menu.query").html(d>0?b:"<li><a>无查询配置</a></li>");1===d&&(_.defer(function(){c.parent().removeClass("open")}),digishell.router.navigate(f.find("a:first").attr("href"),!0))})});break;case"delete":var h=this.model.get("queryFrame")?g.model.get("queryFrame").getSelected(function(a){return a[a.length-1]}):e.getSelected(function(a){return a["@unid"]});if(0===h.length)return $.gritter.add({title:"提示",text:"请先选择文档",time:1500,class_name:"gritter-center gritter-info"}),!1;var i=$.gritter.add({title:"提示",text:'<p>是否删除所选文档？</p><p style="text-align: right"><a class="btn btn-small btn-danger sure" href="#">确定</a>&nbsp;<a class="btn btn-small cancel">取消</a></p>',class_name:"gritter-center gritter-info"});$("#gritter-notice-wrapper").on("click","a.btn",function(a){var b=$(a.target);b.hasClass("sure")&&(d(h,g.model.get("isDraft")?1:0,function(){e.refresh()}),a.preventDefault()),$.gritter.remove(i)});break;case"refresh":if(this.model.get("queryFrame"))return;e.refresh();break;case"export":}},exportAction:function(b){var c=$(b.target).attr("href").substring(1),d=this.model.get("queryFrame");a.async("digiflow.excelTools",function(a){if(d){var b=d.dataTable.fnSettings().aoColumns,f=_.map(b.slice(1,b.length-1),function(a){return a.sTitle}),g=[];switch(c){case"current":d.dataTable.find("tbody tr").each(function(){var a=d.dataTable.fnGetData(this);g.push(a.slice(1,a.length-1))});break;case"all":g=_.map(d.dataTable.fnGetData(),function(a){return a.slice(1,a.length-1)})}a.exportArray(g,f)}else{var h=e.state("name");switch(c){case"current":a.exportArray(function(){for(var a,b=[],c=0;a=e.getRowData(c++,"text");)b.push(a);return b}(),function(a){for(var b,c=[],d=0;b=a.columns[d];d++)b.hide||c.push(b.title);return c}(e.state("viewInfo")),h);break;case"all":var i={dbPath:e.state("dbPath"),view:e.state("view"),columns:function(a){for(var b,c=[],d=0;b=a.columns[d];d++)b.hide||c.push(d);return c}(e.state("viewInfo")),fileName:h};e.state("category")&&(i.category=e.state("category")),e.state("key")&&(i.key=e.state("key")),a.exportView(i)}}}),b.preventDefault()}}),k=new i;c.exports=k}),!function(a){"function"==typeof define&&define.cmd?define("digiflow/0.2/viewPanel",["jquery"],function(b){return b.async("digiflow/0.2/viewPanel.css"),a(b("jquery"))}):("digiflow"in window?window.digiflow:window.digiflow={}).viewPanel=a(jQuery)}(function($){function getViewInfo(a){return $.get("/Produce/DigiShell.nsf/getViewInfoAgent?OpenAgent"+(a?"&timeStamp="+(new Date).getTime():""),{db:state.dbPath,category:state.category,view:state.view},function(a){state.viewInfo=a,$.isFunction(config.infoReady)&&config.infoReady.call(viewPanel,state.viewInfo)})}function showViewControl(a){theadNode.hide().empty();var b=$("<tr>").appendTo(theadNode);if(config.rowIndex){var c=$("<th class='index'>序号</th>");config.checkbox&&c.addClass("checkbox").html(config.checkboxTemplate("序号")),b.append(c)}for(var d,e=a.columns,f=0;d=e[f];f++)if(!d.hide){var g=parseInt(d.width/config.thWidthMultiple),h=$("<th data-index='"+f+"' style='width:"+g+"em'>"+d.title+"</th>");!d.sortAsc&&!d.sortDesc||state.category||(h.addClass("sort"),d.sortAsc&&d.sortDesc?h.append("<span><i class='icon-sort'></i></span>"):d.sortAsc?h.append("<span><i class='icon-sort-up'></i></span>"):h.append("<span><i class='icon-sort-down'></i></span>")),b.append(h)}b.append("<th class='detail'>查看</th>"),theadNode.show(),showPager()}function getViewData(noCache){return $.get("/"+state.dbPath+"/"+state.view+"?ReadViewEntries&outputformat=json"+(noCache?"&timeStamp="+(new Date).getTime():""),function(){var a={count:config.count,start:(state.page-1)*config.count+1};return state.sort&&state.sort.type&&(a[state.sort.type]=state.sort.column),state.category&&(a.RestrictToCategory=state.category),state.key&&(a.StartKey=state.key,a.UntilKey=state.key),a}(),function(viewJsonData){"<"===viewJsonData.charAt(0)&&0===viewJsonData.indexOf("<!DOCTYPE")&&-1!==viewJsonData.indexOf('<input name="RedirectTo" value=')&&(alert("连接已超时，请重新登录"),location.href="/name.nsf?login"),state.viewData=eval("("+viewJsonData+")"),$.isFunction(config.dataReady)&&config.dataReady(state.viewData)},"text")}function showViewData(a){var b,c,d=a.viewentry||[];tbodyNode.hide().empty();for(var e=0,f=d.length;f>e;e++){var g=d[e];b=g.entrydata;var h=$("<tr>");if(config.rowIndex){var i=config.count*(state.page-1)+e+1,j=$("<td>"+i+"</td>");config.checkbox&&j.html(config.checkboxTemplate(i)),h.append(j)}for(var k=0;c=b[k++];)h.append("<td>"+getColumnData(c)+"</td>");h.append("<td><a href='/"+state.dbPath+"/"+state.view+"/"+g["@unid"]+"?opendocument&login' target='_blank'>详细信息</a></td>"),tbodyNode.append(h)}tbodyNode.show()}function openDocument(a){window.open("/"+state.dbPath+"/"+state.view+"/"+a+"?opendocument&login","_blank")}function getColumnData(a){var b=[],c=function(a){return 10>a?"0"+a:a};for(var d in a)switch(d){case"textlist":for(var e,f=a.textlist.text,g=0;e=f[g++];){var h=[];for(var i in e)h.push(e[i]);b.push(h.join(","))}break;case"datetime":var j=a[d];for(var k in j){var l=/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2}),(\d{2})([+-]\d{2})/.exec(j[k]),m=new Date(l[1]+"/"+l[2]+"/"+l[3]+" "+l[4]+":"+l[5]+":"+l[6]+"."+l[7]+"0 GMT"+l[8]+"00");isNaN(m)&&(m=new Date(l[1]+"/"+l[2]+"/"+l[3]+" "+l[4]+":"+l[5]+":"+l[6]+" GMT"+l[8]+"00")),b.push(m.getFullYear()+"-"+c(m.getMonth()+1)+"-"+c(m.getDate())+" "+c(m.getHours())+":"+c(m.getMinutes())+":"+c(m.getSeconds()))}break;default:if(0!==d.indexOf("@")){var n=a[d];for(var o in n)b.push(n[o])}}return b.join(";")}function showPager(){var a=parseInt(state.viewInfo.entriesCount||0),b=state.page,c=state.pageCount=parseInt(a/config.count)+(a%config.count>0?1:0);pagerNode||(pagerNode=$("<div class='pagination'><ul></ul><span class='sum'>共<span class='badge'>"+a+"</span>条文档</span>").appendTo(domNode),pagerNode.find("ul").click(function(a){a.preventDefault();var b=$(a.target),c=b.parent();if(!c.hasClass("active")&&!c.hasClass("disabled")){var d=b.attr("href").substring(1),e=!1;switch(d){case"first":state.page=1;break;case"before":state.page=state.page>1?state.page-1:1,e=!0;break;case"after":state.page=state.page<state.pageCount?state.page+1:state.pageCount,e=!0;break;case"last":state.page=state.pageCount;break;case"more":dialogNode.find(".pageNum").val(state.page).focus(),dialogNode.find(".add-on").text(state.pageCount),dialogNode.modal();break;default:state.page=parseInt(d)}switchPage(e)}}));var d=pagerNode.find("ul").hide().empty(),e=1,f=parseInt(config.pagerSize/2),g="";f>b&&b+config.pagerSize>c&&c>config.pagerSize?e=c-config.pagerSize+1:b+f>=c&&c>config.pagerSize?e=c-f-parseInt(f/2):b>=f&&c>config.pagerSize&&(e=b-parseInt(f/2)),g+="<li"+(1===b?" class='disabled'":"")+"><a href='#before'>前一页</a></li>";for(var h=0;h<config.pagerSize&&c>h;h++){var i=h+e;0===h&&i>1&&c>config.pagerSize?(g+="<li><a href='#1'>1</a></li>",e--):1===h&&b>f&&c>config.pagerSize?(g+="<li><a href='#more'>...</a></li>",e--):g+=h===config.pagerSize-2&&c>config.pagerSize&&c-b>2+parseInt(f/2)?"<li><a href='#more'>...</a></li>":h===config.pagerSize-1&&c>config.pagerSize&&b!==c?"<li><a href='#"+c+"'>"+c+"</a></li>":"<li "+(b===i?" class='active'":"")+"><a href='#"+i+"'>"+i+"</a></li>"}g+="<li"+String(b===c||0===c?" class='disabled'":"")+"><a href='#after'>后一页</a></li>",d.html(g).show(),pagerNode.find(".sum .badge").text(a)}function theadClick(a){var b=a.target;if("INPUT"===b.tagName)tableNode.find("tbody input:checkbox").prop("checked",b.checked);else{var c=$(a.target).closest("th"),d=c.index()-1,e=state.viewInfo.columns[c.data("index")];if(e&&(e.sortAsc||e.sortDesc)){void 0!==state.sort.column&&state.sort.column!==d&&($(a.target).closest("thead").find("th span.sorting").removeClass("sorting").find("i").get(0).className="icon-sort",state.viewInfo.columns[state.sort.column].sortState=0);var f,g=c.find("span"),h=g.find("i")[0];if(e.sortState=e.sortState||0,e.sortState++,e.sortAsc&&e.sortDesc)switch(f=e.sortState%3){case 0:g.removeClass("sorting"),h.className="icon-sort";break;case 1:g.addClass("sorting"),h.className="icon-sort-up";break;case 2:h.className="icon-sort-down"}else f=e.sortState%2,g.toggleClass("sorting"),e.sortDesc&&(f=1===f?2:f);state.sort={type:SORT_TYPES[f],column:SORT_TYPES[f]?d:void 0},getViewData().done(function(){showViewData(state.viewData)})}}}var config={parent:".viewData",rowIndex:!0,checkbox:!1,thWidthMultiple:1.5,count:30,pagerSize:7,checkboxTemplate:function(a){return"<label class='checkbox'><input type='checkbox'/>"+a+"</label>"},infoReady:null,dataReady:null},state={page:1,dbPath:"",view:"",category:null,key:null,sort:{},pageCount:1,viewData:null,viewInfo:null},SORT_TYPES=["","ResortAscending","ResortDescending"],domNode,tableNode,theadNode,tbodyNode,pagerNode,dialogNode,switchPage=function(){var a,b=function(){showViewData(state.viewData)};return function(c){a&&clearTimeout(a),showPager(),c?a=setTimeout(function(){getViewData().done(b)},300):getViewData().done(b)}}(),viewPanel={el:function(){return tableNode},config:function(a,b){return"object"==typeof a?$.extend(config,a):"undefined"!=typeof a&&"undefined"!=typeof b?config[a]=b:a?config[a]:config},state:function(a){var b=$.extend({},state);return a?b[a]:b},init:function(a){this.config(a),domNode=$(config.parent).addClass("viewPanelParent"),tableNode=$("<table class='table table-bordered table-striped table-hover viewPanel'></table>").appendTo(domNode),theadNode=$("<thead style='width: 100%'></thead>").appendTo(tableNode).click(theadClick),tbodyNode=$("<tbody></tbody>").appendTo(tableNode).dblclick(function(a){var b=$(a.target).closest("tr").index(),c=state.viewData.viewentry[b]["@unid"];openDocument(c)}),dialogNode=$("<div class='modal' style='display:none'><div class='modal-header'><a class='close' data-dismiss='modal'>×</a><h3>页面跳转</h3></div><div class='modal-body'><div class='input-append'>请输入跳转的页面：<input class='pageNum input-xlarge focused' type='text' /><span class='add-on'></span></div></div><div class='modal-footer'><a href='#' class='btn btn-primary sure'>确定</a></div></div>").appendTo(domNode),dialogNode.find(".pageNum").keypress(function(a){13===a.which&&(a.preventDefault(),this.value>=1&&this.value<=state.pageCount&&(state.page=parseInt(this.value),switchPage(),dialogNode.modal("hide")))}),dialogNode.find(".sure").click(function(a){a.preventDefault();var b=parseInt(dialogNode.find(".pageNum").val());b>=1&&b<=state.pageCount&&(state.page=b,switchPage(),dialogNode.modal("hide"))})},openView:function(a){domNode||this.init(),$.extend(state,{page:1,category:null,key:null,sort:{}},a),this.refresh()},refresh:function(){$.when(getViewInfo(!0),getViewData(!0)).done(function(){tableNode.css("display","inline-table"),setTimeout(function(){tableNode.css("display","")},0),showViewControl(state.viewInfo),showViewData(state.viewData)}).fail(function(){alert("错误：无法打开视图")})},getRowData:function(a,b){var c=state.viewData.viewentry[a];if("text"===(b||"all")&&c){for(var d,e=[],f=0;d=c.entrydata[f++];)e.push(getColumnData(d));c=e}return c},getSelected:function(a){var b=this,c=[];return tbodyNode.find("input:checkbox:checked").each(function(){var d=$(this).closest("tr"),e=d.index(),f=b.getRowData(e);a?(f=a(f,e,d),null!=f&&c.push(f)):c.push(f)}),c}};return viewPanel}),function(a){"function"==typeof define&&define.cmd?define("jquery/gritter/1.7.4/jquery.gritter",["jquery"],function(b){b.async("jquery/gritter/1.7.4/css/jquery.gritter.css"),a(b("jquery"))}):a(jQuery)}(function(a){!function(a){a.gritter={},a.gritter.options={position:"",class_name:"",fade_in_speed:"medium",fade_out_speed:1e3,time:6e3},a.gritter.add=function(a){try{return b.add(a||{})}catch(c){var d="Gritter Error: "+c;"undefined"!=typeof console&&console.error?console.error(d,a):alert(d)}},a.gritter.remove=function(a,c){b.removeSpecific(a,c||{})},a.gritter.removeAll=function(a){b.stop(a||{})};var b={position:"",fade_in_speed:"",fade_out_speed:"",time:"",_custom_timer:0,_item_count:0,_is_setup:0,_tpl_close:'<a class="gritter-close" href="#" tabindex="1">Close Notification</a>',_tpl_title:'<span class="gritter-title">[[title]]</span>',_tpl_item:'<div id="gritter-item-[[number]]" class="gritter-item-wrapper [[item_class]]" style="display:none" role="alert"><div class="gritter-top"></div><div class="gritter-item">[[close]][[image]]<div class="[[class_name]]">[[title]]<p>[[text]]</p></div><div style="clear:both"></div></div><div class="gritter-bottom"></div></div>',_tpl_wrap:'<div id="gritter-notice-wrapper"></div>',add:function(c){if("string"==typeof c&&(c={text:c}),null===c.text)throw'You must supply "text" parameter.';this._is_setup||this._runSetup();var d=c.title,e=c.text,f=c.image||"",g=c.sticky||!1,h=c.class_name||a.gritter.options.class_name,i=a.gritter.options.position,j=c.time||"";this._verifyWrapper(),this._item_count++;var k=this._item_count,l=this._tpl_item;a(["before_open","after_open","before_close","after_close"]).each(function(d,e){b["_"+e+"_"+k]=a.isFunction(c[e])?c[e]:function(){}}),this._custom_timer=0,j&&(this._custom_timer=j);var m=""!=f?'<img src="'+f+'" class="gritter-image" />':"",n=""!=f?"gritter-with-image":"gritter-without-image";if(d=d?this._str_replace("[[title]]",d,this._tpl_title):"",l=this._str_replace(["[[title]]","[[text]]","[[close]]","[[image]]","[[number]]","[[class_name]]","[[item_class]]"],[d,e,this._tpl_close,m,this._item_count,n,h],l),this["_before_open_"+k]()===!1)return!1;a("#gritter-notice-wrapper").addClass(i).append(l);var o=a("#gritter-item-"+this._item_count);return o.fadeIn(this.fade_in_speed,function(){b["_after_open_"+k](a(this))}),g||this._setFadeTimer(o,k),a(o).bind("mouseenter mouseleave",function(c){"mouseenter"==c.type?g||b._restoreItemIfFading(a(this),k):g||b._setFadeTimer(a(this),k),b._hoverState(a(this),c.type)}),a(o).find(".gritter-close").click(function(){return b.removeSpecific(k,{},null,!0),!1}),k},_countRemoveWrapper:function(b,c,d){c.remove(),this["_after_close_"+b](c,d),0==a(".gritter-item-wrapper").length&&a("#gritter-notice-wrapper").remove()},_fade:function(a,c,d,e){var d=d||{},f="undefined"!=typeof d.fade?d.fade:!0,g=d.speed||this.fade_out_speed,h=e;this["_before_close_"+c](a,h),e&&a.unbind("mouseenter mouseleave"),f?a.animate({opacity:0},g,function(){a.animate({height:0},300,function(){b._countRemoveWrapper(c,a,h)})}):this._countRemoveWrapper(c,a)},_hoverState:function(a,b){"mouseenter"==b?(a.addClass("hover"),a.find(".gritter-close").show()):(a.removeClass("hover"),a.find(".gritter-close").hide())},removeSpecific:function(b,c,d,e){if(!d)var d=a("#gritter-item-"+b);this._fade(d,b,c||{},e)},_restoreItemIfFading:function(a,b){clearTimeout(this["_int_id_"+b]),a.stop().css({opacity:"",height:""})},_runSetup:function(){for(opt in a.gritter.options)this[opt]=a.gritter.options[opt];this._is_setup=1},_setFadeTimer:function(a,c){var d=this._custom_timer?this._custom_timer:this.time;this["_int_id_"+c]=setTimeout(function(){b._fade(a,c)},d)},stop:function(b){var c=a.isFunction(b.before_close)?b.before_close:function(){},d=a.isFunction(b.after_close)?b.after_close:function(){},e=a("#gritter-notice-wrapper");c(e),e.fadeOut(function(){a(this).remove(),d()})},_str_replace:function(a,b,c,d){var e=0,f=0,g="",h="",i=0,j=0,k=[].concat(a),l=[].concat(b),m=c,n=l instanceof Array,o=m instanceof Array;for(m=[].concat(m),d&&(this.window[d]=0),e=0,i=m.length;i>e;e++)if(""!==m[e])for(f=0,j=k.length;j>f;f++)g=m[e]+"",h=n?void 0!==l[f]?l[f]:"":l[0],m[e]=g.split(k[f]).join(h),d&&m[e]!==g&&(this.window[d]+=(g.length-m[e].length)/k[f].length);return o?m:m[0]},_verifyWrapper:function(){0==a("#gritter-notice-wrapper").length&&a("body").append(this._tpl_wrap)}}}(a)});