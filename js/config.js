define("/DigiShell/js/config",["./sidebar","backbone/backbone/1.1.0/backbone","jquery","backbone/underscore/1.5.2/underscore","./util","./widgets","jquery/bootstrap/fuelux/tree","jquery/gridster/0.2.1/jquery.gridster"],function(a,b){var c=a("./sidebar"),d=a("./widgets"),e=a("backbone/backbone/1.1.0/backbone"),f=a("backbone/underscore/1.5.2/underscore"),g=a("./util");a("jquery/bootstrap/fuelux/tree"),a("jquery/gridster/0.2.1/jquery.gridster");var h=function(a,b){this._items=a,this._selectedItems=b};h.prototype.data=function(a,b){function c(a,b){if("root"===a.get("id"))return[];var d,e=a.get("parentId"),f=[];return"root"!==e&&(f.push(e),(d=b.get(e))&&(f=f.concat(c(d,b)))),f}var d=this._items,e=this._selectedItems,g=e?function(){var a=[];return e.each(function(b){a=f.unique(a.concat(c(d.get(b.get("id")),d)))}),a}():null,h={};return"name"in a||"type"in a?("type"in a&&"folder"===a.type&&f.each(d.where({parentId:a.id}),function(a){var b=d.findWhere({parentId:a.id})?"folder":"item";h[a.id]=f.extend({},a.attributes,{type:b,checked:"folder"===b?null:e?!!e.findWhere({id:a.id}):!1,expanded:"folder"===b?-1!==f.indexOf(g,a.id):null})}),null!=d&&setTimeout(function(){b({data:h})},parseInt(500*Math.random(),0)+200),void 0):(f.each(d.where({parentId:"root"}),function(a){var b=d.findWhere({parentId:a.id})?"folder":"item";h[a.id]=f.extend({},a.attributes,{type:b,expanded:"folder"===b?-1!==f.indexOf(g,a.id):null})}),b({data:h}),void 0)};var i=!1;b.init=function(){function a(a){var c=d.getWidget(a.wId,a),e=c.$el.clone();e.addClass("mini").removeAttr("id").find("[id]").removeAttr("id"),e.find(".badge").text("");var f=b.add_widget($("<li></li>").append(e),a.size_x,a.size_y,a.col||1,a.row||1);f.data("widgetConfig",a)}if(!i){$(".page-content .config").html('<div class="span12"><div class="tabbable"><ul class="nav nav-tabs" id="config_Tab"><li class="active"><a data-toggle="tab" href="#config_hotFormConfig_Tab">常用申请</a></li><li><a data-toggle="tab" href="#config_hotAppConfig_Tab">常用应用</a></li><li><a data-toggle="tab" href="#config_WidgetConfig_Tab">首页组件</a></li></ul><div class="tab-content"><div id="config_hotFormConfig_Tab" class="tab-pane in active"></div><div id="config_hotAppConfig_Tab" class="tab-pane"></div><div id="config_WidgetConfig_Tab" class="tab-pane"><h3 class="header smaller lighter green">配置首页组件</h3><div class="row-fluid"><div class="gridster span10"><ul></ul></div><div class="span2" style="overflow-x: auto;white-space: nowrap;"><div class="tree"></div></div></div></div></div></div></div>');{var b,j=c.openMenu("hotForm"),k=c.getMenu("hotApp"),l=c.getSiteMap("hotFormMap",{el:$("#config_hotFormConfig_Tab")[0],selectable:!0,selected:j.model});c.getSiteMap("hotAppMap",{el:$("#config_hotAppConfig_Tab")[0],selectable:!0,selected:k.model})}$("#config_hotFormConfig_Tab").on("select",function(a,b,c){var d=[{id:"root",level:0}].concat(f.map(c,function(a){return{id:a.id,ico:a.get("ico"),name:a.get("formName")||a.get("name"),dbPath:a.get("dbPath"),form:a.get("form"),source:a.get("source"),parentId:"root"}}));g.localConfig("hotFormConfig",d),j.model.reset(d),j.render("root")}),$("#config_hotAppConfig_Tab").on("select",function(a,b,c){var d=[{id:"root",level:0}].concat(f.map(c,function(a){return{id:a.id,ico:a.get("ico"),name:a.get("name"),dbPath:a.get("dbPath"),view:a.get("view"),source:a.get("source"),parentId:"root"}}));g.localConfig("hotAppConfig",d),k.model.reset(d),k.render("root")}),$("#config_Tab").on("shown",function(c){var e=$(c.target).closest("li").index();switch(e){case 0:$("#sidebar-shortcuts-large a:eq("+e+")").tab("show");break;case 1:$("#sidebar-shortcuts-large a:eq("+e+")").tab("show");break;case 2:if(0===$("#config_WidgetConfig_Tab .gridster li").size()){var h=$(document).width()<1200?90:120;b=$("#config_WidgetConfig_Tab .gridster > ul").gridster({widget_margins:[5,5],widget_base_dimensions:[h,h],max_cols:6,serialize_params:function(a,b){return f.extend(a.data("widgetConfig"),{col:b.col,row:b.row,size_x:b.size_x,size_y:b.size_y})},draggable:{stop:function(){g.localConfig("widgetsConfig",b.serialize()),digishell.widgets.destory()}}}).data("gridster"),d.loadWidget("",function(){f.each(g.localConfig("widgetsConfig")||d.DEFAULT_WIDGET,function(b){a(b)})})}$("#sidebar-shortcuts-large a:first").tab("show")}}),$("#config_WidgetConfig_Tab .gridster").on("click",function(){return!1}),l.getItem("root",function(c,i){var j=new e.Collection(i.map(function(a){var b=a.clone();return b.attributes={ico:a.get("ico"),id:a.get("id"),name:a.get("name"),parentId:a.get("parentId")},"root"===a.get("parentId")&&b.set("parentId","widget_menu"),b.set({wId:"shortcut",size_x:1,size_y:1}),b}));j.add([{id:"widget_gsxw",wId:"gsxw",name:"公司新闻",size_x:3,size_y:2,parentId:"widget"},{id:"widget_rwxx",wId:"RWXX",name:"任务消息",size_x:3,size_y:2,parentId:"widget"},{id:"widget_xzgg",wId:"xzgg",name:"行政公告",size_x:3,size_y:2,parentId:"widget"},{id:"widget_hydt",wId:"hydt",name:"制度流程",size_x:3,size_y:2,parentId:"widget"},{id:"widget_bbs",wId:"bbs",name:"企业论坛",size_x:3,size_y:2,parentId:"widget"},{id:"widget_cppx",wId:"cppx",name:"企业培训",size_x:3,size_y:2,parentId:"widget"},{id:"widget_mail",wId:"mail",name:"邮件",size_x:3,size_y:1,parentId:"widget"},{id:"widget_weather",wId:"weather",name:"天气",size_x:3,size_y:1,parentId:"widget"},{id:"widget_menu",name:"菜单",parentId:"root"},{id:"widget",name:"组件",parentId:"root"}]),$("#config_WidgetConfig_Tab .tree").ace_tree({dataSource:new h(j,new e.Collection(g.localConfig("widgetsConfig")||d.DEFAULT_WIDGET)),multiSelect:!0,loadingHTML:'<div class="tree-loading"><i class="icon-refresh icon-spin blue"></i></div>',"open-icon":"icon-minus","close-icon":"icon-plus",selectable:!0,"selected-icon":"icon-ok","unselected-icon":"icon-remove"}).on("selected",function(c,d){var e=$(".gridster .gs_w"),h=e.filter(function(){return!f.findWhere(d.info,{id:$(this).data("widgetConfig").id})}),i=f.filter(d.info,function(a){return 0===e.filter(function(){return $(this).data("widgetConfig").id===a.id}).size()});h.each(function(){b.remove_widget(this)}),f.each(i,function(b){var c=f.extend({},b);delete c.type,delete c.checked,delete c.expanded,a(c)}),g.localConfig("widgetsConfig",b.serialize()),digishell.widgets.destory()})})}}});